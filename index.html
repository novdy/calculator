<!Doctype html>
<html>
    <head>
        <title>Calculator</title>
        <link rel="stylesheet" type="text/css" href="bootstrap-reboot.min.css">
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>

    <body>
        <div id="container">
            <div id="display-mini">0</div>
            <div id="display">0</div>
            <button id="b1">1</button><button id="b2">2</button><button id="b3">3</button><button id="plus">+</button><button id="del">&lt;=</button>
            <button id="b4">4</button><button id="b5">5</button><button id="b6">6</button><button id="minus">-</button>
            <button id="b7">7</button><button id="b8">8</button><button id="b9">9</button><button id="times">&times;</button>
            <button id="bC">C</button><button id="b0">0</button><button id="dot">.</button><button id="divide">&div;</button><button id="eq">=</button>
        </div>
    </body>

    <script>        
        let operation = Array();
        let decimalPlaces = 10;
        let buffer;
        let bufferIsPrimed = false;

        function update(number){
            let disp = document.getElementById('display');
            disp.removeChild(disp.firstChild);
            let res = document.createTextNode(number);
            disp.appendChild(res);
            updateMini();
        }

        function updateMini(){
            let dispmini = document.getElementById('display-mini');
            if(dispmini.firstChild){
                dispmini.removeChild(dispmini.firstChild);
                let resmini = "";
                for (let i = 0; i < operation.length; i++){
                    numString = operation[i];
                    if (i != 0){
                        if (i % 2 === 0 && numString.includes('.') && numString[numString.length - 1] != '.'){
                            console.log(i + ': ' + operation[i] + ': ' + operation[i]);
                            operation[i] = (Math.round(+numString * 10**decimalPlaces) / 10**decimalPlaces).toString();
                        }
                    }                    
                    resmini += operation[i];
                }
                
                if (resmini.length > 0){
                    dispmini.appendChild(document.createTextNode(resmini));
                }
            }
        }

        function bufferIsPrimedRelativeIndexOfOperator(index){
            if(operation[operation.length + index] === '+'){
                buffer += +operation[operation.length + index + 1];
            } else if(operation[operation.length + index] === '-'){
                buffer -= +operation[operation.length + index + 1];
            } else if(operation[operation.length + index] === '\u00D7'){
                buffer *= +operation[operation.length + index + 1];
            } else if(operation[operation.length + index] === '\u00F7'){
                buffer /= +operation[operation.length + index + 1];
            }
            buffer = Math.round(buffer * 10**decimalPlaces) / 10**decimalPlaces
            update(buffer);
        }

        function bufferIsNotPrimedRelativeIndexOfOperator(index){
            if(operation[operation.length + index] === '+'){
                buffer = +operation[operation.length + index - 1] + +operation[operation.length + index + 1];
            } else if(operation[operation.length + index] === '-'){
                buffer = +operation[operation.length + index - 1] - +operation[operation.length + index + 1];
            } else if(operation[operation.length + index] === '\u00D7'){
                buffer = +operation[operation.length + index - 1] * +operation[operation.length + index + 1];
            } else if(operation[operation.length + index] === '\u00F7'){
                buffer = +operation[operation.length + index - 1] / +operation[operation.length + index + 1];
            }
            buffer = Math.round(buffer * 10**decimalPlaces) / 10**decimalPlaces
            update(buffer);
        }

        function operate(){
            if (operation.length == 3){
                if (bufferIsPrimed){
                    bufferIsPrimedRelativeIndexOfOperator(-2);
                } else {
                    bufferIsNotPrimedRelativeIndexOfOperator(-2);
                }
            } else if (operation.length == 4){
                if (bufferIsPrimed){
                    bufferIsPrimedRelativeIndexOfOperator(-3);
                } else {
                    bufferIsNotPrimedRelativeIndexOfOperator(-3);
                }
            } else if (!['+', '-', '\u00D7', '\u00F7'].includes(operation[operation.length - 1])) {
                bufferIsPrimedRelativeIndexOfOperator(-2);
            } else if (operation.length > 4) {
                bufferIsPrimedRelativeIndexOfOperator(-3);
            } 
        }

        let btns = document.querySelectorAll('button');
        btns.forEach((btn) => {
            btn.addEventListener('click', () => {
                if (btn.id === 'eq'){
                    operate();
                    bufferIsPrimed = true;
                    operation = Array();
                    operation.push(buffer);
                    updateMini();
                } else if (btn.id === 'bC'){
                    bufferIsPrimed = false;
                    operation = Array();
                    update('0');
                    document.getElementById('display-mini').appendChild(document.createTextNode('0'));
                } else if (btn.id === 'plus'){
                    if(operation.length % 2 === 0 && operation.length != 0){
                        operation[operation.length - 1] = '+';
                        updateMini();
                    } else if (operation.length % 2 === 1){
                        operation.push('+');
                        updateMini();
                        operate();
                    }
                } else if (btn.id === 'minus'){
                    if(operation.length % 2 === 0 && operation.length != 0){
                        operation[operation.length - 1] = '-';
                        updateMini();
                    } else if (operation.length % 2 === 1){
                        operation.push('-');
                        updateMini();
                        operate();
                    }
                } else if (btn.id === 'times'){
                    if(operation.length % 2 === 0 && operation.length != 0){
                        operation[operation.length - 1] = '\u00D7';
                        updateMini();
                    } else if (operation.length % 2 === 1){
                        operation.push('\u00D7');
                        updateMini();
                        operate();
                    }
                } else if (btn.id === 'divide'){
                    if(operation.length % 2 === 0 && operation.length != 0){
                        operation[operation.length - 1] = '\u00F7';
                        updateMini();
                    } else if (operation.length % 2 === 1){
                        operation.push('\u00F7');
                        updateMini();
                        operate();
                    }
                } else if (btn.id === 'dot'){
                    if (operation.length % 2 == 0) {
                        operation.push('.');
                        update(operation[operation.length - 1]);
                    } else if (!(bufferIsPrimed && operation.length === 1)){
                        if (!operation[operation.length - 1].includes('.')){
                            operation[operation.length - 1] += '.';
                            update(operation[operation.length - 1]);    
                        }
                    } else if (bufferIsPrimed && operation.length === 1){
                        bufferIsPrimed = false;
                        operation = Array();
                        operation.push('.');
                        update(operation[operation.length - 1]);
                    }
                } else if (operation.length % 2 == 0){
                    operation.push(btn.textContent)
                    update(operation[operation.length - 1]);
                } else if (bufferIsPrimed && operation.length === 1){
                    bufferIsPrimed = false;
                    operation = Array();
                    operation.push(btn.textContent);
                    update(operation[operation.length - 1]);
                }
                else {
                    operation[operation.length - 1] += btn.textContent.toString();
                    update(operation[operation.length - 1]);
                }
            })
        })
    </script>
</html>