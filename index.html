<!Doctype html>
<html>
    <head>
        <title>Calculator</title>
        <link rel="stylesheet" type="text/css" href="bootstrap-reboot.min.css">
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>

    <body>
        <div id="container">
            <div id="display-mini">0</div>
            <div id="display">0</div>
            <button id="b1">1</button><button id="b2">2</button><button id="b3">3</button><button id="plus">+</button><button id="del">&lt;=</button>
            <button id="b4">4</button><button id="b5">5</button><button id="b6">6</button><button id="minus">-</button>
            <button id="b7">7</button><button id="b8">8</button><button id="b9">9</button><button id="times">&times;</button>
            <button id="bC">C</button><button id="b0">0</button><button id="dot">.</button><button id="divide">&div;</button><button id="eq">=</button>
        </div>
    </body>

    <script>        
        let expression = Array();
        let decimalPlaces = 10;
        let buffer;
        let bufferIsPrimed = false;
        let equalsPressed = false;

        function update(number){
            let disp = document.getElementById('display');
            disp.removeChild(disp.firstChild);
            let res = document.createTextNode(number);
            disp.appendChild(res);
            updateMini();
        }

        function updateMini(){
            let dispmini = document.getElementById('display-mini');
            if(dispmini.firstChild){
                dispmini.removeChild(dispmini.firstChild);
                let resmini = "";
                for (let i = 0; i < expression.length; i++){
                    numString = expression[i];
                    if (i != 0){
                        if (i % 2 === 0 && numString.includes('.') && numString[numString.length - 1] != '.'){
                            console.log(i + ': ' + expression[i] + ': ' + expression[i]);
                            expression[i] = (Math.round(+numString * 10**decimalPlaces) / 10**decimalPlaces).toString();
                        }
                    }                    
                    resmini += expression[i];
                }
                
                if (resmini.length > 0){
                    dispmini.appendChild(document.createTextNode(resmini));
                } else {
                    dispmini.appendChild(document.createTextNode('0'));
                }
            } else {
                dispmini.appendChild(document.createTextNode('0'));
            }
        }

        function bufferIsPrimedRelativeIndexOfOperator(index){
            if(expression[expression.length + index] === '+'){
                buffer += +expression[expression.length + index + 1];
            } else if(expression[expression.length + index] === '-'){
                buffer -= +expression[expression.length + index + 1];
            } else if(expression[expression.length + index] === '\u00D7'){
                buffer *= +expression[expression.length + index + 1];
            } else if(expression[expression.length + index] === '\u00F7'){
                buffer /= +expression[expression.length + index + 1];
            }
            buffer = Math.round(buffer * 10**decimalPlaces) / 10**decimalPlaces
            update(buffer);
        }

        function bufferIsNotPrimedRelativeIndexOfOperator(index){
            if(expression[expression.length + index] === '+'){
                buffer = +expression[expression.length + index - 1] + +expression[expression.length + index + 1];
            } else if(expression[expression.length + index] === '-'){
                buffer = +expression[expression.length + index - 1] - +expression[expression.length + index + 1];
            } else if(expression[expression.length + index] === '\u00D7'){
                buffer = +expression[expression.length + index - 1] * +expression[expression.length + index + 1];
            } else if(expression[expression.length + index] === '\u00F7'){
                buffer = +expression[expression.length + index - 1] / +expression[expression.length + index + 1];
            }
            buffer = Math.round(buffer * 10**decimalPlaces) / 10**decimalPlaces
            update(buffer);
        }

        function operate(){
            if (expression.length == 3){
                if (bufferIsPrimed){
                    bufferIsPrimedRelativeIndexOfOperator(-2);
                } else {
                    bufferIsNotPrimedRelativeIndexOfOperator(-2);
                }
            } else if (expression.length == 4){
                if (bufferIsPrimed){
                    bufferIsPrimedRelativeIndexOfOperator(-3);
                } else {
                    bufferIsNotPrimedRelativeIndexOfOperator(-3);
                }
            } else if (!['+', '-', '\u00D7', '\u00F7'].includes(expression[expression.length - 1])) {
                bufferIsPrimedRelativeIndexOfOperator(-2);
            } else if (expression.length > 4) {
                bufferIsPrimedRelativeIndexOfOperator(-3);
            } 
        }

        let btns = document.querySelectorAll('button');
        btns.forEach((btn) => {
            btn.addEventListener('click', () => {
                if (btn.id === 'eq'){
                    if (!['+', '-', '\u00D7', '\u00F7'].includes(expression[expression.length - 1])){
                        operate();
                        bufferIsPrimed = true;
                        expression = Array();
                        expression.push(buffer);
                        updateMini();
                    }                    
                } else if (btn.id === 'bC'){
                    expression = Array();
                    update('0');
                    bufferIsPrimed = false;
                } else if (btn.id === 'plus'){
                    if(expression.length % 2 === 0 && expression.length != 0){
                        expression[expression.length - 1] = '+';
                        updateMini();
                    } else if (expression.length % 2 === 1){
                        expression.push('+');
                        updateMini();
                        operate();
                    }
                } else if (btn.id === 'minus'){
                    if(expression.length % 2 === 0 && expression.length != 0){
                        expression[expression.length - 1] = '-';
                        updateMini();
                    } else if (expression.length % 2 === 1){
                        expression.push('-');
                        updateMini();
                        operate();
                    }
                } else if (btn.id === 'times'){
                    if(expression.length % 2 === 0 && expression.length != 0){
                        expression[expression.length - 1] = '\u00D7';
                        updateMini();
                    } else if (expression.length % 2 === 1){
                        expression.push('\u00D7');
                        updateMini();
                        operate();
                    }
                } else if (btn.id === 'divide'){
                    if(expression.length % 2 === 0 && expression.length != 0){
                        expression[expression.length - 1] = '\u00F7';
                        updateMini();
                    } else if (expression.length % 2 === 1){
                        expression.push('\u00F7');
                        updateMini();
                        operate();
                    }
                } else if (btn.id === 'del'){
                    if (expression.length != 0){
                        if(bufferIsPrimed && expression.length === 1){
                            expression.pop();
                            update('0');
                            bufferIsPrimed = false;
                        } else if (!['+','-','\u00D7','\u00F7'].includes(expression[expression.length - 1])) {
                            expression[expression.length - 1] = expression[expression.length - 1].slice(0,-1);
                            if (expression[expression.length - 1] === ''){
                                expression.pop();
                                if (expression.length === 0){
                                    update('0');
                                } else {
                                    update(expression[expression.length - 2]);
                                }
                            } else if (!['+','-','\u00D7','\u00F7'].includes(expression[expression.length - 1])){
                                update(expression[expression.length - 1]);
                            }
                        }
                    }                    
                } else if (bufferIsPrimed && expression.length === 1){
                    expression = Array();
                    expression.push(btn.textContent);
                    update(expression[expression.length - 1]);
                    bufferIsPrimed = false;
                } else if (btn.id === 'dot'){
                    if (expression.length % 2 == 0) {
                        expression.push('.');
                        update(expression[expression.length - 1]);
                    } else if (!(bufferIsPrimed && expression.length === 1)){
                        if (!expression[expression.length - 1].includes('.')){
                            expression[expression.length - 1] += '.';
                            update(expression[expression.length - 1]);    
                        }
                    } 
                } else if (expression.length % 2 == 0){
                    expression.push(btn.textContent)
                    update(expression[expression.length - 1]);
                } else {
                    expression[expression.length - 1] += btn.textContent.toString();
                    update(expression[expression.length - 1]);
                }
            })
        })
    </script>
</html>